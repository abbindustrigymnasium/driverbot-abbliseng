<html>

<head>
    <meta charset="utf-8">
    <title>Driverbot</title>
    <link rel="stylesheet" href="./stylesheet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript" import
        iro from "@jaames/iro" ;>
        </script>
    <script>
        function onFail() {
            //document.getElementById("messages").innerHTML += '<span>ERROR: Connection to: ' + host + ' on port: ' +
            port + ' failed.</span><br/>'
            console.log('Misslyckades med anslutning till: '+document.getElementById('fname').value+'/')
            
            document.getElementById('lightConnected').setAttribute('class', 'connected1')
            document.getElementById('lightConnecting').setAttribute('class', 'connecting1')
            document.getElementById('lightDisconnected').setAttribute('class', 'disconnected')

        }
        let topic = "abbexpectmore@gmail.com/";

        // Called when the client connects
        function onConnect() {
            // Fetch the MQTT topic from the form
            topic = document.getElementById("fname").value + '/'
            topic += document.getElementById("topic").value;
            console.log("Du är ansluten till: " + topic);

            //topic2 += document.getElementById("topic").value;
            //console.log("Du är ansluten till: " + topic2);
            // Print output for the user in the messages div
            //document.getElementById("messages").innerHTML += '<span>Subscribing to: ' + topic + '</span><br/>';
            // Subscribe to the requested topic
            client.subscribe(document.getElementById("fname").value +'/'+ document.getElementById('messages').value);
            message = new Paho.MQTT.Message("Connected!");
            message.destinationName = topic;
            client.send(message);
            
            document.getElementById('lightConnected').setAttribute('class', 'connected')
            document.getElementById('lightConnecting').setAttribute('class', 'connecting1')
            document.getElementById('lightDisconnected').setAttribute('class', 'disconnected1')

            // topic = document.getElementById("fname").value + '/'

            // client.subscribe(topic2);
            // message = new Paho.MQTT.Message("Connected!");
            // message.destinationName = topic2;
            // client.send(message);
        }
        function drive(power, speed, turn) {
            let mess4 = `(${power}:${speed}:${turn})`;
            message = new Paho.MQTT.Message(mess4);
            message.destinationName = "abbexpectmore@gmail.com/ctrl";
            client.send(message);
        }

        // Called when the client loses its connection
        function onConnectionLost(responseObject) {
            //document.getElementById("messages").innerHTML += '<span>ERROR: Connection lost</span><br/>';
            if (responseObject.errorCode !== 0) {
                document.getElementById("messages").innerHTML += '<span>ERROR: ' + +responseObject.errorMessage +
                    '</span><br/>';
            }
        }

        // Called when a message arrives
        function onMessageArrived(message) {
            console.log("onMessageArrived: " + message.payloadString);
            document.getElementById("messages").innerHTML += '<span>Topic: ' + message.destinationName + '  | ' +
                message.payloadString + '</span><br/>';
        }

        // Called when the disconnection button is pressed
        function startDisconnect() {
            client.disconnect();
            window.location.reload();
            // document.getElementById("messages").innerHTML += '<span>Disconnected</span><br/>';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro"></script>
</head>

<body>
    <script>
        function startConnect() {
            // Generate a random client ID
            clientID = "clientID_" + parseInt(Math.random() * 100);

            // Fetch the hostname/IP address and port number from the form
            host = "maqiatto.com";
            port = 8883;

            '</span><br/>';

            '</span><br/>';
            // Initialize new Paho client connection
            client = new Paho.MQTT.Client(host, Number(port), clientID);
            // Set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            document.getElementById('lightConnected').setAttribute('class', 'connected1')
            document.getElementById('lightConnecting').setAttribute('class', 'connecting')
            document.getElementById('lightDisconnected').setAttribute('class', 'disconnected1')

            client.connect({
                userName: document.getElementById("fname").value,
                password: document.getElementById("password").value,
                onSuccess: onConnect,
                onFailure: onFail,
            });
        }
        // window.onload = startConnect()
    </script>
</body>

<script>
    let holding = false
    //Button graphics
    function pressMid(btn, style1, style2) {
        document.getElementById(btn).setAttribute("class", style1)
        setTimeout(function () {
            document.getElementById(btn).setAttribute("class", style2)
        }, 200)
    }
    function mouseUp(btn, style) {
        document.getElementById(btn).setAttribute("class", style)
        holding = false
    }
    function mouseDown(btn, style) {
        document.getElementById(btn).setAttribute("class", style)
        holding = true
        hold(btn)
    }
    function hold(btn) {
        if (holding) {
            if (btn == 'up') {
                speed(10)
                setTimeout(hold, 500, btn)
            } else if (btn == 'down') {
                speed(-10)
                setTimeout(hold, 500, btn)
            } else if (btn == 'right') {
                turn(1)
                setTimeout(hold, 1, btn)
            } else if (btn == 'left') {
                turn(-1)
                setTimeout(hold, 1, btn)
            }

        }
    }
    var POWER = "0";
    let output = 0;
    let placeholder = 0;
    function speed(value) {
        output += value
        if (output == 340){
            output -= value
        } else if (output == -340){
            output -= value
        }

        if (output < 0){
            this.POWER = 0
            placeholder = output * -1
        } else {
            this.POWER = 1
            placeholder = output
        }
        placeholder += 700

        drive(this.POWER, placeholder, turning)
    }
    let turning = 90
    function turn(value) {
        if (turning + value < 30 || turning + value > 150) {
            null
        } else {
            turning += value
        }
        drive(this.POWER, placeholder, turning)
    }
    function speedReset() {
        this.POWER = 0
        placeholder = 0
        drive(this.POWER, placeholder, turning)
    }
    function turnReset() {
        turning = 90
        drive(this.POWER, placeholder, turning)
    }

    function tryConnect(){
        if (document.getElementById('lightConnected').className == 'connected') {
            console.log('Du är redan ansluten, om det ej funkar var vänlig ladda om sidan.')
        }else {
            startConnect()
        }
    }
</script>

<body class="background">
    <!-- <div class="progress"></div> -->
    <div id="lightConnected" class="connected1"></div>
    <div id="lightConnecting" class="connecting1"></div>
    <div id="lightDisconnected" class="disconnected"></div>
    <div class="outline center">

        <div class="inner-square">

            <div class="left-sector">
                <div class="a">
                    <div id="left" class="left" onmousedown="mouseDown('left', 'left shadow-left')"
                        onmouseup="mouseUp('left', 'left');">
                        <div class="triangle-left"></div>
                    </div>
                    <div id="right" class="right" onmousedown="mouseDown('right', 'right shadow-right')"
                        onmouseup="mouseUp('right', 'right');">
                        <div class="triangle-right"></div>
                    </div>
                </div>
                <div class="b">
                    <div id="up" class="up" onmousedown="mouseDown('up', 'up shadow-up')"
                        onmouseup="mouseUp('up', 'up');">
                        <div class="triangle-up"></div>
                    </div>
                    <div class="middle">
                        <div class="middle1"></div>
                    </div>
                    <div id="down" class="down" onmousedown="mouseDown('down', 'down shadow-down')"
                        onmouseup="mouseUp('down', 'down');">
                        <div class="triangle-down"></div>
                    </div>
                </div>
            </div>

            <div class="center-sector">
                <div class="mid-square"
                    style="margin-top: 0px; border-top-right-radius: 0px; border-top-left-radius: 0px;">
                </div>
                <div class="mid-square"></div>
                <div class="mid-square">
                    <div class="mid-text-box">
                        <span>SELECT</span>
                        <span>START</span>
                    </div>
                </div>
                <div class="mid-buttons border">
                    <div id="btn-mid" class="mid-button"
                        onclick="pressMid('btn-mid', 'mid-button-pressed', 'mid-button');selectForm()">
                    </div>
                    <div id="btn-mid-1" class="mid-button"
                        onclick="pressMid('btn-mid-1', 'mid-button-pressed', 'mid-button');tryConnect()"></div>
                </div>
                <div class="bot-square"></div>
            </div>

            <div class="right-sector">
                <div class="text-field">
                    <span style="font-family: Nintendo; font-size: 25px;">Spetsen</span>
                    <span class="r-mark">®</span>
                </div>
                <div class="buttons">
                    <div class="square">
                        <div id="B" class="circle" onclick="pressMid('B', 'circle-pressed', 'circle');turnReset()">
                        </div>
                    </div>
                    <div class="square">
                        <div id="A" class="circle" onclick="pressMid('A', 'circle-pressed', 'circle');speedReset()">
                        </div>
                    </div>
                </div>
                <div class="text-again">
                    <span>B</span>
                    <span style="margin-left: 50px;">A</span>
                </div>
            </div>

        </div>
    </div>
    <div id="select-form">
        <form id="connection-information-form">
            <label for="fname">Username:</label>
            <input type="text" id="fname" name="fname" value="abbexpectmore@gmail.com"><br>
            <label for="password">Password:</label>
            <input type="text" id="password" name="password"><br>
            <label for="topic">Topic:</label>
            <input type="text" id="topic" value="ctrl"><br>
            <label for="messages">Subscribe:</label>
            <input type="text" id="messages" value="">
        </form>
    </div>
</body>

<script>
    function selectForm(){
        var x = document.getElementById('select-form');
        if (x.style.display === "none"){
            x.style.display = "block";
        } else {
            x.style.display = "none"
        }
    }
</script>

</html>