<html>

<head>
  <meta charset="utf-8">
  <title>Wall-E</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript" import iro
    from "@jaames/iro" ;>
    </script>
  <script>
    function onFail() {
      //document.getElementById("messages").innerHTML += '<span>ERROR: Connection to: ' + host + ' on port: ' +
      port + ' failed.</span><br/>'
    }
    let topic = "abbexpectmore@gmail.com/ctrl";

    // Called when the client connects
    function onConnect() {
      // Fetch the MQTT topic from the form
      topic += document.getElementById("topic").value;
      console.log("Du är ansluten till: " + topic);

      //topic2 += document.getElementById("topic").value;
      //console.log("Du är ansluten till: " + topic2);
      // Print output for the user in the messages div
      //document.getElementById("messages").innerHTML += '<span>Subscribing to: ' + topic + '</span><br/>';
      // Subscribe to the requested topic
      client.subscribe(topic);
      message = new Paho.MQTT.Message("Connected!");
      message.destinationName = topic;
      client.send(message);

      // client.subscribe(topic2);
      // message = new Paho.MQTT.Message("Connected!");
      // message.destinationName = topic2;
      // client.send(message);
    }
    function drive(turn, speed) {
      speed = -1 * speed;
      let mess4 = `${turn + ":" + speed}`;
      message = new Paho.MQTT.Message(mess4);
      message.destinationName = "abbexpectmore@gmail.com/ctrl";
      client.send(message);
    }

    // Called when the client loses its connection
    function onConnectionLost(responseObject) {
      //document.getElementById("messages").innerHTML += '<span>ERROR: Connection lost</span><br/>';
      if (responseObject.errorCode !== 0) {
        document.getElementById("messages").innerHTML += '<span>ERROR: ' + +responseObject.errorMessage +
          '</span><br/>';
      }
    }

    // Called when a message arrives
    function onMessageArrived(message) {
      console.log("onMessageArrived: " + message.payloadString);
      document.getElementById("messages").innerHTML += '<span>Topic: ' + message.destinationName + '  | ' +
        message.payloadString + '</span><br/>';
    }

    // Called when the disconnection button is pressed
    function startDisconnect() {
      client.disconnect();
      window.location.reload();
      // document.getElementById("messages").innerHTML += '<span>Disconnected</span><br/>';
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro"></script>
</head>

<body>
  <script>
    function startConnect() {
      // Generate a random client ID
      clientID = "clientID_" + parseInt(Math.random() * 100);

      // Fetch the hostname/IP address and port number from the form
      host = "maqiatto.com";
      port = 8883;

      '</span><br/>';

      '</span><br/>';
      // Initialize new Paho client connection
      client = new Paho.MQTT.Client(host, Number(port), clientID);
      // Set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      client.connect({
        userName: "abbexpectmore@gmail.com",
        password: "hej",
        onSuccess: onConnect,
        onFailure: onFail,
      });
    }
    window.onload = startConnect();
  </script>
</body>

<body class="noselect all" onload="init();">
  <div class="container space-top">
    <div class="center-align">
      <canvas id="joystick" height="300" width="300"></canvas>
    </div>
    <p id="xVal" class="light">X: </p>
    <p id="yVal" class="light">Y: </p>
  </div>
</body>

</html>
<style>
  body {
    height: 100%;
    width: 100%;
    background-color: #dedede;
  }

  .space-top {
    padding-top: 10px;
  }

  #joystick {
    height: 300px;
    width: 300px;
    border-radius: 300px;
    -moz-border-radius: 300px;
    -webkit-border-radius: 300px;
    text-align: center;
    background-color: #80d5ff;
    font: 24px/300px Helvetica, Arial, sans-serif;
    cursor: all-scroll;
    user-select: none;
    z-index: -100;
  }

  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
</style>
<script src="../node_modules/easeljs/lib/easeljs.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="../node_modules/tweenjs/lib/tweenjs.js"></script>
<script src="../node_modules/hammerjs/hammer.js"></script>
<script>
  function init() {
    // easal stuff goes hur
    var xCenter = 150;
    var yCenter = 150;
    var stage = new createjs.Stage('joystick');

    var psp = new createjs.Shape();
    psp.graphics.beginFill('#333333').drawCircle(xCenter, yCenter, 50);

    psp.alpha = 0.25;

    var vertical = new createjs.Shape();
    var horizontal = new createjs.Shape();
    vertical.graphics.beginFill('#ff4d4d').drawRect(150, 0, 2, 300);
    horizontal.graphics.beginFill('#ff4d4d').drawRect(0, 150, 300, 2);

    stage.addChild(psp);
    stage.addChild(vertical);
    stage.addChild(horizontal);
    createjs.Ticker.framerate = 60;
    createjs.Ticker.addEventListener('tick', stage);
    stage.update();

    var myElement = $('#joystick')[0];

    // create a simple instance
    // by default, it only adds horizontal recognizers
    var mc = new Hammer(myElement);

    mc.on("panstart", function (ev) {
      var pos = $('#joystick').position();
      xCenter = psp.x;
      yCenter = psp.y;
      psp.alpha = 0.5;

      stage.update();
    });

    // listen to events...
    mc.on("panmove", function (ev) {
      var pos = $('#joystick').position();

      var x = (ev.center.x - pos.left - 150);
      var y = (ev.center.y - pos.top - 150);
      $('#xVal').text('X: ' + x);
      $('#yVal').text('Y: ' + (-1 * y));
      drive(x, y);

      var coords = calculateCoords(ev.angle, ev.distance);

      psp.x = coords.x;
      psp.y = coords.y;

      psp.alpha = 0.5;

      stage.update();
    });

    mc.on("panend", function (ev) {
      psp.alpha = 0.25;
      createjs.Tween.get(psp).to({ x: xCenter, y: yCenter }, 750, createjs.Ease.elasticOut);
    });
  }

  function calculateCoords(angle, distance) {
    var coords = {};
    distance = Math.min(distance, 100);
    var rads = (angle * Math.PI) / 180.0;

    coords.x = distance * Math.cos(rads);
    coords.y = distance * Math.sin(rads);

    return coords;
  }
</script>